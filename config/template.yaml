# =========================
# 1. 基础环境设置 (服务器安全默认)
# =========================
mixed-port: 7890
socks-port: 7891
tproxy-port: 7893

allow-lan: false
bind-address: "127.0.0.1"

ipv6: false
log-level: info
mode: rule

# 面板：服务器建议仅本机（需要远程用 SSH 隧道）
external-controller: 127.0.0.1:9090
external-ui: "ui"
secret: "CHANGE_ME_TO_A_STRONG_SECRET"

profile:
  store-selected: true

# =========================
# 2. DNS 设置（服务器默认仅本机）
# =========================
dns:
  enable: true
  listen: 127.0.0.1:1053
  enhanced-mode: fake-ip
  fake-ip-range: 198.18.0.1/16
  default-nameserver:
    - 223.5.5.5
    - 119.29.29.29
  nameserver:
    - https://dns.google/dns-query
    - https://1.1.1.1/dns-query
  direct-nameserver:
    - 223.5.5.5
    - 119.29.29.29

# =========================
# 3. 节点订阅（proxy-providers）
# =========================
proxy-providers:
  UserSub:
    type: http
    url: "INSERT_LINK_HERE" # [SUBLINK]
    path: ./sub/usersub.yaml
    interval: 3600
    health-check:
      enable: true
      interval: 600
      url: http://www.gstatic.com/generate_204

# =========================
# 4. 规则集（全部使用 yaml/text；不使用 mrs）
# =========================
rule-providers:
  # ADBlock：用 Loyalsoldier 的 reject.txt（text/domain）
  # 你的规则里仍然是 RULE-SET,ADBlock,广告拦截
  ADBlock:
    type: http
    behavior: domain
    format: text
    interval: 86400
    url: "https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/reject.txt"
    path: ./ruleset/ADBlock.txt

  AdditionalFilter:
    type: http
    behavior: classical
    format: text
    interval: 86400
    url: https://gcore.jsdelivr.net/gh/powerfullz/override-rules@master/ruleset/AdditionalFilter.list
    path: ./ruleset/AdditionalFilter.list

  SogouInput:
    type: http
    behavior: classical
    format: text
    interval: 86400
    url: https://ruleset.skk.moe/Clash/non_ip/sogouinput.txt
    path: ./ruleset/SogouInput.txt

  StaticResources:
    type: http
    behavior: domain
    format: text
    interval: 86400
    url: https://ruleset.skk.moe/Clash/domainset/cdn.txt
    path: ./ruleset/StaticResources.txt

  CDNResources:
    type: http
    behavior: classical
    format: text
    interval: 86400
    url: https://ruleset.skk.moe/Clash/non_ip/cdn.txt
    path: ./ruleset/CDNResources.txt

  AdditionalCDNResources:
    type: http
    behavior: classical
    format: text
    interval: 86400
    url: https://gcore.jsdelivr.net/gh/powerfullz/override-rules@master/ruleset/AdditionalCDNResources.list
    path: ./ruleset/AdditionalCDNResources.list

  EHentai:
    type: http
    behavior: classical
    format: text
    interval: 86400
    url: https://gcore.jsdelivr.net/gh/powerfullz/override-rules@master/ruleset/EHentai.list
    path: ./ruleset/EHentai.list

  TikTok:
    type: http
    behavior: classical
    format: text
    interval: 86400
    url: https://gcore.jsdelivr.net/gh/powerfullz/override-rules@master/ruleset/TikTok.list
    path: ./ruleset/TikTok.list

  SteamFix:
    type: http
    behavior: classical
    format: text
    interval: 86400
    url: https://gcore.jsdelivr.net/gh/powerfullz/override-rules@master/ruleset/SteamFix.list
    path: ./ruleset/SteamFix.list

  GoogleFCM:
    type: http
    behavior: classical
    format: text
    interval: 86400
    url: https://gcore.jsdelivr.net/gh/powerfullz/override-rules@master/ruleset/FirebaseCloudMessaging.list
    path: ./ruleset/GoogleFCM.list

  # 国内出口：用 meta-rules-dat 的 yaml（mihomo 官方示例就这么用）
  cn_domain:
    type: http
    behavior: domain
    format: yaml
    interval: 86400
    url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/cn.yaml"
    path: ./ruleset/cn_domain.yaml

  cn_ip:
    type: http
    behavior: ipcidr
    format: yaml
    interval: 86400
    url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/cn.yaml"
    path: ./ruleset/cn_ip.yaml

  geolocation_not_cn:
    type: http
    behavior: domain
    format: yaml
    interval: 86400
    url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/geolocation-!cn.yaml"
    path: ./ruleset/geolocation_not_cn.yaml

# =========================
# 5. 策略组（每组可直接选具体节点 + 🇨🇳 仅筛 🇨🇳）
# =========================
proxy-groups:
  - name: 🚀 节点选择
    type: select
    proxies:
      - DIRECT
    use:
      - UserSub

  - name: ⚡ 自动优选
    type: url-test
    url: http://www.gstatic.com/generate_204
    interval: 300
    tolerance: 50
    use:
      - UserSub

  - name: 🇨🇳 国内自动优选
    type: url-test
    url: http://www.gstatic.com/generate_204
    interval: 300
    tolerance: 50
    use:
      - UserSub
    filter: "🇨🇳"

  - name: 🇨🇳 国内出口
    type: select
    proxies:
      - 🇨🇳 国内自动优选
      - DIRECT
      - 🚀 节点选择
      - ⚡ 自动优选
    use:
      - UserSub
    filter: "🇨🇳"

  - name: 🇨🇳 国内出口-模式
    type: select
    proxies:
      - 🇨🇳 国内出口
      - DIRECT
      - 🚀 节点选择
      - ⚡ 自动优选

  # === 业务组：都能直接选具体节点 ===
  - name: 📹 YouTube
    type: select
    proxies:
      - DIRECT
      - ⚡ 自动优选
      - 🚀 节点选择
      - 🇨🇳 国内出口
    use: [UserSub]

  - name: 🎵 Spotify
    type: select
    proxies:
      - DIRECT
      - ⚡ 自动优选
      - 🚀 节点选择
      - 🇨🇳 国内出口
    use: [UserSub]

  - name: 💳 PayPal
    type: select
    proxies:
      - DIRECT
      - 🚀 节点选择
      - ⚡ 自动优选
    use: [UserSub]

  - name: 🤖 AI & Copilot
    type: select
    proxies:
      - DIRECT
      - ⚡ 自动优选
      - 🚀 节点选择
    use: [UserSub]

  - name: 📺 其他流媒体
    type: select
    proxies:
      - DIRECT
      - ⚡ 自动优选
      - 🚀 节点选择
    use: [UserSub]

  - name: 💰 虚拟货币
    type: select
    proxies:
      - DIRECT
      - 🚀 节点选择
      - ⚡ 自动优选
    use: [UserSub]

  - name: 📲 电报消息
    type: select
    proxies:
      - DIRECT
      - ⚡ 自动优选
      - 🚀 节点选择
    use: [UserSub]

  - name: 🐟 漏网之鱼
    type: select
    proxies:
      - 🚀 节点选择
      - ⚡ 自动优选
      - 🇨🇳 国内出口-模式
      - DIRECT
    use: [UserSub]

  # === 规则类分组（不需要展开节点）===
  - name: 广告拦截
    type: select
    proxies:
      - REJECT
      - REJECT-DROP
      - DIRECT

  - name: 搜狗输入
    type: select
    proxies:
      - REJECT-DROP
      - DIRECT

  - name: Truth Social
    type: select
    proxies:
      - DIRECT
      - ⚡ 自动优选
      - 🚀 节点选择
    use: [UserSub]

  - name: 静态资源
    type: select
    proxies:
      - DIRECT
      - 🚀 节点选择
      - ⚡ 自动优选
    use: [UserSub]

  - name: E-Hentai
    type: select
    proxies:
      - DIRECT
      - ⚡ 自动优选
      - 🚀 节点选择
    use: [UserSub]

  - name: TikTok
    type: select
    proxies:
      - DIRECT
      - ⚡ 自动优选
      - 🚀 节点选择
    use: [UserSub]

  - name: Steam修复
    type: select
    proxies:
      - DIRECT
      - 🚀 节点选择
      - ⚡ 自动优选
    use: [UserSub]

  - name: Play商店修复
    type: select
    proxies:
      - DIRECT
      - ⚡ 自动优选
      - 🚀 节点选择
    use: [UserSub]

  - name: FCM推送
    type: select
    proxies:
      - DIRECT
      - 🚀 节点选择
      - ⚡ 自动优选
    use: [UserSub]

# =========================
# 6. 分流规则（国内不直连：CN -> 🇨🇳 国内出口-模式）
# =========================
rules:
  # 管理口/自环直连
  - DST-PORT,22,DIRECT
  - DST-PORT,9090,DIRECT
  - DST-PORT,7890,DIRECT
  - DST-PORT,7891,DIRECT
  - DST-PORT,7893,DIRECT

  # 私网永远直连（服务器/网关都必须留）
  - GEOIP,private,DIRECT

  # 广告/过滤
  - RULE-SET,ADBlock,广告拦截
  - RULE-SET,AdditionalFilter,广告拦截
  - RULE-SET,SogouInput,搜狗输入

  # 静态/CDN
  - RULE-SET,StaticResources,静态资源
  - RULE-SET,CDNResources,静态资源
  - RULE-SET,AdditionalCDNResources,静态资源

  # Truth Social
  - DOMAIN-SUFFIX,truthsocial.com,Truth Social

  # 专项/修复
  - RULE-SET,EHentai,E-Hentai
  - RULE-SET,TikTok,TikTok
  - RULE-SET,SteamFix,Steam修复
  - RULE-SET,GoogleFCM,FCM推送
  - DOMAIN,services.googleapis.cn,Play商店修复

  # 业务分流（保持你原逻辑）
  - GEOSITE,youtube,📹 YouTube
  - GEOSITE,spotify,🎵 Spotify
  - GEOSITE,paypal,💳 PayPal

  - GEOSITE,category-ai-!cn,🤖 AI & Copilot
  - GEOSITE,openai,🤖 AI & Copilot
  - GEOSITE,anthropic,🤖 AI & Copilot
  - GEOSITE,google-gemini,🤖 AI & Copilot
  - GEOSITE,github,🤖 AI & Copilot

  - GEOSITE,netflix,📺 其他流媒体
  - GEOSITE,disney,📺 其他流媒体
  - GEOSITE,hbo,📺 其他流媒体
  - GEOSITE,category-porn,📺 其他流媒体

  - GEOSITE,category-cryptocurrency,💰 虚拟货币
  - GEOSITE,binance,💰 虚拟货币
  - GEOSITE,okx,💰 虚拟货币

  - GEOSITE,telegram,📲 电报消息
  - GEOIP,telegram,📲 电报消息

  - GEOSITE,google,🚀 节点选择
  - GEOSITE,microsoft,🚀 节点选择

  # 国内：不直连 -> 走“国内出口-模式”（你可在面板切 DIRECT）
  - RULE-SET,cn_domain,🇨🇳 国内出口-模式
  - RULE-SET,cn_ip,🇨🇳 国内出口-模式

  # 兜底
  - RULE-SET,geolocation_not_cn,🐟 漏网之鱼
  - MATCH,🐟 漏网之鱼
